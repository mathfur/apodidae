#!/usr/bin/env ruby

require 'getoptlong'
require 'fileutils'
require './lib/apodidae'

usage = <<EOS
Usage: apodidae [options]
    -w, --watch     compile automatically when template or source is changed.
EOS
output_dir = "#{File.dirname(__FILE__)}/.."

opts = GetoptLong.new(
  ['--help', '-h', GetoptLong::NO_ARGUMENT],
  ['--version', '-v', GetoptLong::NO_ARGUMENT],
  ['--watch', '-w', GetoptLong::NO_ARGUMENT],
  ['--barb-dir', '-b', GetoptLong::OPTIONAL_ARGUMENT],
  ['--rachis-dir', '-r', GetoptLong::OPTIONAL_ARGUMENT],
  ['--connection-file', '-c', GetoptLong::OPTIONAL_ARGUMENT],
  ['--foo-output-file', '-o', GetoptLong::OPTIONAL_ARGUMENT]
)

manager = Apodidae::Manager.new

begin
  opts.each do |opt, arg|
    case opt
    when '--help'; puts usage; exit
    when '--version'; puts Apodidae::VERSION; exit
    when '--watch'; puts 'before implementation.'; exit
    when '--barb-dir'
      manager.add_barb_from_file(arg)
    when '--rachis-dir'
      manager.add_rachis_from_file(arg)
    when '--connection-file'
      manager.set_connection_from_file(arg)
    when '--foo-output-file'
      output_dir = arg
    else
    end
  end
rescue
  puts ">>Exception"
  exit
end

manager.generate
manager.write_to(:foo => output_dir)
